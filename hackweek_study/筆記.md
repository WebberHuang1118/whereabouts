# Visiting Whereabouts Design

## Summary

Whereabouts is an IP Address Management (IPAM) plugin for Container Network Interface (CNI). It is designed to manage IP address allocation in Kubernetes for secondary interfaces

Key Features of Whereabouts:
- **IP Range Management**: Handles IP address allocation from pre-configured IP pools (CIDR ranges).
- **State Persistence**: Stores allocation state in a backend (e.g., Kubernetes etcd), ensuring IPs are not reused while in use.
- **Cluster-Wide Scope**: Supports cross-node IP management, allowing IPs to be allocated uniquely across the cluster

In essence, Whereabouts isn't a full-fledged CNI plugin for network connectivity but rather an IPAM solution for managing IP addresses in a Kubernetes environment

## Github Repo

https://github.com/k8snetworkplumbingwg/whereabouts

## Architecture

### CNI plugin executable for Whereabouts

1. [Installed by Whereabout's Daemonset on each node](https://github.com/k8snetworkplumbingwg/whereabouts/blob/57d5ac368f1c88b0d63219d0ca91b303fa597450/doc/crds/daemonset-install.yaml#L122)

2. Called by the CNI Framework:
    - The Kubernetes kubelet invokes the CNI plugin binaries (including Whereabouts) during Pod network setup and teardown.

3. IP Address Management (IPAM):
    - The binary is responsible for managing IP addresses for Pods' network interfaces.
    - When a Pod is created, the CNI plugin (e.g., Multus) calls the Whereabouts binary to:
        - Allocate an IP address from a predefined IP range.
        - Ensure that IPs are unique and consistent across nodes.

4. Release of IP Addresses:
    - When a Pod is deleted, the Whereabouts binary is called again to:
        - Release the IP address that was assigned to the Pod.
        - Mark the IP as available for reuse.

### ip-control-loop

1. Synchronization Across Nodes:
    - The loop runs on each node as [part of the DaemonSet](https://github.com/k8snetworkplumbingwg/whereabouts/blob/57d5ac368f1c88b0d63219d0ca91b303fa597450/doc/crds/daemonset-install.yaml#L123), helping maintain cluster-wide consistency for IP address usage.

2. Monitoring and Reconciliation of IP Allocations:
    - It ensures that the IP address allocations stored in the CRD
    - It periodically checks the allocated IPs and releases them if they are no longer associated with active Pods.

3. Garbage Collection:
    - If a Pod is deleted unexpectedly (e.g., due to a crash) and its IP address was not released properly, ip-control-loop identifies the stale IP allocation and frees it.
    - This prevents IP address exhaustion in the cluster.

## Design

### CRD

- `IPPool`
    ```
    // IPAllocation represents metadata about the pod/container owner of a specific IP
    type IPAllocation struct {
        ContainerID string `json:"id"`
        PodRef      string `json:"podref"`
        IfName      string `json:"ifname,omitempty"`
    }
    ```
    ```
    // IPPoolSpec defines the desired state of IPPool
    type IPPoolSpec struct {
        // Range is a RFC 4632/4291-style string that represents an IP address and prefix length in CIDR notation
        Range string `json:"range"`
        // Allocations is the set of allocated IPs for the given range. Its` indices are a direct mapping to the
        // IP with the same index/offset for the pool's range.
        Allocations map[string]IPAllocation `json:"allocations"`
    }
    ```

    1. **Allocated IP Addresses**: Tracks which IPs have been assigned to Pods.

    2. **Available IP Addresses**: Indicates which IPs are free for allocation.

    3. **Consistency Across Nodes**: Ensures cluster-wide uniqueness of IP addresses within a given range.

- `OverlappingRangeIPReservation`
    ```
    // OverlappingRangeIPReservationSpec defines the desired state of OverlappingRangeIPReservation
    type OverlappingRangeIPReservationSpec struct {
        ContainerID string `json:"containerid,omitempty"`
        PodRef      string `json:"podref"`
        IfName      string `json:"ifname,omitempty"`
    }
    ```

    1. **Manage Overlapping IP Ranges**:
        - In cases where different networks or IP pools have overlapping CIDR ranges, this CRD tracks the allocations across all ranges to avoid IP conflicts.

    2. **Cluster-Wide Consistency**:
        - Ensures that IPs allocated from overlapping ranges are unique across the cluster.

    3. **Reconciliation**:
        - Acts as a global reservation registry for IP addresses in overlapping ranges.

### Working Flow

1. IP Allocation (Add Request)
    - Entry point [cmdAdd](https://github.com/k8snetworkplumbingwg/whereabouts/blob/bcf436fec3dbb0dd953c200ae04629f397af62b7/cmd/whereabouts.go#L22-L33)

2. IP Release (Del Request)
    - Entry point [cmdDel](https://github.com/k8snetworkplumbingwg/whereabouts/blob/bcf436fec3dbb0dd953c200ae04629f397af62b7/cmd/whereabouts.go#L36-L50)

3. IP Reconciliation
    - [Pod controller adding](https://github.com/k8snetworkplumbingwg/whereabouts/blob/bcf436fec3dbb0dd953c200ae04629f397af62b7/cmd/controlloop/controlloop.go#L137-L145)

    - [Pod reconciler](https://github.com/k8snetworkplumbingwg/whereabouts/blob/bcf436fec3dbb0dd953c200ae04629f397af62b7/pkg/controlloop/pod.go#L177-L251)

4. IP Reconcile Scheduler
    - [Schedule Adding](https://github.com/k8snetworkplumbingwg/whereabouts/blob/bcf436fec3dbb0dd953c200ae04629f397af62b7/cmd/controlloop/controlloop.go#L68-L77)

    - [Reconcile IP](https://github.com/k8snetworkplumbingwg/whereabouts/blob/bcf436fec3dbb0dd953c200ae04629f397af62b7/pkg/reconciler/ip.go#L14-L45)
